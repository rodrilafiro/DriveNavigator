<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriveNavigator XP - v1.61 (Full Restore)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body, #root { height: 100vh; width: 100vw; margin: 0; padding: 0; overflow: hidden; background-color: #5a7edc; }
        .xp-blue-gradient { background: linear-gradient(to bottom, #0058e6, #3b89ff, #0058e6); }
        .preview-pane { background: linear-gradient(to bottom, #748aff, #d6dff7); border-left: 1px solid #0058e6; }
        .xp-panel-header { background: linear-gradient(to right, #2151d1, #7392f7); color: white; padding: 2px 8px; font-weight: bold; border-radius: 4px 4px 0 0; }
        .xp-panel-body { background: #d6dff7; border: 1px solid #ffffff; border-top: none; padding: 8px; margin-bottom: 8px; }
        th { cursor: pointer; user-select: none; background: #f1f1f1; border-right: 1px solid #ccc; border-bottom: 1px solid #ccc; font-weight: normal; }
        .xp-context-menu { box-shadow: 2px 2px 5px rgba(0,0,0,0.4); border: 1px solid #716f64; background-color: white; z-index: 9999; }
        .xp-context-item:hover { background-color: #316ac5; color: white; }
        /* Media Player Windows */
        .media-player-win { position: fixed; top: 15%; left: 25%; width: 500px; background: #ece9d8; border: 3px solid #0058e6; z-index: 10000; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const CLIENT_ID = "483723699126-qnf9lr8p8c9cnud19lkceiv92022c1rs.apps.googleusercontent.com";
        const SCOPES = "https://www.googleapis.com/auth/drive";

        const App = () => {
            const [tokenClient, setTokenClient] = useState(null);
            const [accessToken, setAccessToken] = useState(null);
            const [files, setFiles] = useState([]);
            const [currentFolder, setCurrentFolder] = useState({ id: 'root', name: 'Mi unidad' });
            const [expandedFolders, setExpandedFolders] = useState({});
            const [selectedIds, setSelectedIds] = useState([]);
            const [contextMenu, setContextMenu] = useState(null);
            const [clipboard, setClipboard] = useState({ ids: [], action: null });
            const [activeMedia, setActiveMedia] = useState(null);
            const fileInputRef = useRef(null);

            const getIcon = (f) => {
                if (f.mimeType.includes('folder')) return "üìÅ";
                if (f.mimeType.includes('audio')) return "üéµ";
                if (f.mimeType.includes('video')) return "üé¨";
                if (f.mimeType.includes('image')) return "üñºÔ∏è";
                return "üìÑ";
            };

            useEffect(() => {
                const scriptGis = document.createElement('script');
                scriptGis.src = "https://accounts.google.com/gsi/client";
                scriptGis.onload = () => {
                    const client = window.google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID, scope: SCOPES,
                        callback: (resp) => { if (resp.access_token) setAccessToken(resp.access_token); },
                    });
                    setTokenClient(client);
                };
                document.head.appendChild(scriptGis);
            }, []);

            const fetchFiles = async (folderId) => {
                if (!accessToken) return;
                try {
                    const res = await fetch(`https://www.googleapis.com/drive/v3/files?q='${folderId}' in parents and trashed = false&fields=files(id, name, mimeType, size, modifiedTime, webViewLink)&pageSize=100`, {
                        headers: { Authorization: `Bearer ${accessToken}` }
                    });
                    const data = await res.json();
                    setFiles(data.files || []);
                } catch (e) { console.error(e); }
            };

            useEffect(() => { if (accessToken) fetchFiles(currentFolder.id); }, [accessToken, currentFolder.id]);

            const toggleFolder = async (id) => {
                if (expandedFolders[id]) { setExpandedFolders(prev => ({ ...prev, [id]: null })); }
                else {
                    const res = await fetch(`https://www.googleapis.com/drive/v3/files?q='${id}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false&fields=files(id, name)`, {
                        headers: { Authorization: `Bearer ${accessToken}` }
                    });
                    const data = await res.json();
                    setExpandedFolders(prev => ({ ...prev, [id]: data.files || [] }));
                }
            };

            const handleFileClick = (id, e) => {
                e.stopPropagation();
                if (e.ctrlKey) {
                    setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
                } else {
                    setSelectedIds([id]);
                }
            };

            const apiCall = async (url, method, body) => {
                await fetch(url, {
                    method, headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: body ? JSON.stringify(body) : undefined
                });
                fetchFiles(currentFolder.id);
            };

            const handlePaste = async () => {
                if (!clipboard.ids.length) return;
                for (const id of clipboard.ids) {
                    if (clipboard.action === 'copy') {
                        await fetch(`https://www.googleapis.com/drive/v3/files/${id}/copy`, {
                            method: 'POST', headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ parents: [currentFolder.id] })
                        });
                    }
                }
                setClipboard({ ids: [], action: null });
                fetchFiles(currentFolder.id);
            };

            const FolderTree = ({ folder, level = 0 }) => (
                <div key={folder.id}>
                    <div className={`flex items-center gap-1 p-1 cursor-pointer hover:bg-blue-100 ${currentFolder.id === folder.id ? 'bg-[#316ac5] text-white' : ''}`} style={{ paddingLeft: `${level * 10 + 4}px` }}>
                        <span className="w-4 font-mono text-[9px]" onClick={(e) => { e.stopPropagation(); toggleFolder(folder.id); }}>
                            {expandedFolders[folder.id] ? '[-]' : '[+]'}
                        </span>
                        <span className="truncate" onClick={() => {setCurrentFolder({id: folder.id, name: folder.name}); setSelectedIds([]);}}>üìÅ {folder.name}</span>
                    </div>
                    {expandedFolders[folder.id] && expandedFolders[folder.id].map(sub => <FolderTree key={sub.id} folder={sub} level={level + 1} />)}
                </div>
            );

            // Pantalla de Bienvenida XP
            if (!accessToken) return (
                <div className="h-full w-full flex flex-col items-center justify-center bg-[#5a7edc] text-white font-sans overflow-hidden">
                    <div className="w-full h-1/2 bg-[#003399] flex items-center justify-center border-b-4 border-[#ff8a00]">
                         <h1 className="text-7xl font-bold italic drop-shadow-xl">Windows<span className="text-[#ff8a00]">xp</span></h1>
                    </div>
                    <div className="w-full h-1/2 flex items-center justify-center bg-[#5a7edc] gap-12">
                        <div className="flex flex-col items-center">
                            <div onClick={() => tokenClient.requestAccessToken()} className="w-24 h-24 bg-blue-600 rounded-lg border-2 border-white shadow-xl flex items-center justify-center text-5xl cursor-pointer hover:scale-105 transition-transform active:brightness-90">üë§</div>
                            <p className="mt-4 text-2xl font-bold drop-shadow-md">Workspace User</p>
                            <p className="text-blue-100 italic">Haga clic aqu√≠ para iniciar sesi√≥n</p>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="h-full w-full flex flex-col bg-[#ece9d8] font-sans text-[11px]" onClick={() => {setSelectedIds([]); setContextMenu(null);}}>
                    <div className="h-7 xp-blue-gradient flex items-center justify-between px-2 text-white font-bold">
                        <span>üìÇ {currentFolder.name} - DriveNavigator v1.61</span>
                        <button onClick={() => window.location.reload()} className="bg-red-600 px-3 h-5 rounded-sm">X</button>
                    </div>

                    <div className="flex-1 flex overflow-hidden">
                        {/* Panel Izquierdo: Arbol Pro */}
                        <div className="w-56 bg-white border-r border-gray-400 overflow-y-auto" onClick
